!function xcss(){"use strict";function stateChanged(){var e=location.hash.replace(/^#\/?/,"").split("/").map(function(e){var t=e.split("?"),n=(t[1]||"").split("&"),s=t[0],l={};return l[s]={},n.forEach(function(e){var t=e.split("="),n=t[0],o=decodeURIComponent(t[1]);l[s][n]=o}),l});e.path=e.map(function(e){return Object.keys(e)[0]}).join("/"),e.params={},e.forEach(function(t){var n=t[Object.keys(t)[0]];Object.keys(n).forEach(function(t){e.params[t]=n[t]})}),console.log("state:",e),stateListeners.forEach(function(t){t(e)}),window.setTimeout(function(){pullBoundElements()},100),prevState=e}function bindAllContent(e,t){return t&&t>MAX_NESTING_LEVEL?void console.log("Max nesting level is: "+MAX_NESTING_LEVEL):(t++,void Object.keys(contentBindings).forEach(function(n){insertContent(contentBindings,n,null,null,null,e,t)}))}function bindAllEvents(e){Object.keys(evtBindings).forEach(function(t){for(var n=e||document,s=n.querySelectorAll(t),l=0;l<s.length;l++){var o=evtBindings[t];s[l].xcssHandler||(console.log("binding message events: "+o.hash+" to "+t),"prevent"===o.hash?s[l].xcssHandler=function(e){e.preventDefault(),e.stopPropagation()}:s[l].xcssHandler=makeEventListener(o.hash),s[l].addEventListener(o.event,s[l].xcssHandler))}})}function bindAllClasses(e){Object.keys(classBindings).forEach(function(t){var n=e||document,s=n.querySelectorAll(t)||[],l=classBindings[t]||[];[].slice.call(s).forEach(function(e){l.forEach(function(n){console.log("applying "+n+" to "+t),e.classList.add(n)})})})}function processCSSRulesAsync(){window.setTimeout(processCSSRules,100)}function processCSSRules(){console.time("processCSSRules"),collectRules(document),compileRules(allCSSRules),console.timeEnd("processCSSRules"),stateChanged()}function compileRules(e){Object.keys(e).forEach(function(t){var n,s,l,o="",r="",a=[],c={},i=t.split('"').map(function(e,t){return t%2===1?(c["$"+t]=e,"$"+t):e}).join('"'),u=i.split(KEYWORDS);if(!visitedRules[t])if(visitedRules[t]=e[t],console.log("parts: ["+u.join(" : "),"] selector:",t),n="",u.length>2){if(r=u.shift().trim().replace(/"\$(\d+)"/g,'"'+c.$1+'"'),o=u.shift().trim(),s=o.toUpperCase(),l=o.toLowerCase(),a=u.filter(function(e){var t=KEYWORD_FUNCTIONS[e.toUpperCase()];return n=t&&LogicKeyword!==t?o:n,!t}).map(function(e){return e.replace(/"\$\d+"/g,function(e){return'"'+c[e.replace(/"/g,"")]+'"'})}),n)return void console.error('cannot proces invalid xcss rule: "'+t+'" unexpected keyword "'+n+'"');KEYWORD_FUNCTIONS[s]?KEYWORD_FUNCTIONS[s](e,t,r,a,o):EVENTS.indexOf(s)>=0&&eventRule(e,t,r,a,l)}else e[t].style.content&&insertContent(e,t,r,a,o)})}function insertContent(cssRules,selector,target,sources,keyword,parent,level){var url,matches,urlAttr,content=cssRules[selector].style.content||"",targetElms=document.querySelectorAll(selector);parent&&(targetElms=parent.querySelectorAll(selector)),/:(before|after)/.test(selector)||(contentBindings[selector]||(contentBindings[selector]={style:{content:allCSSRules[selector].style.content}}),console.log("inserting content for: "+selector),(matches=content.match(/^url\(([^)]*)\)$/))&&(url=matches[1],(matches=url.match(/^"(.*)"$/))&&(url=url.slice(1,-1)),(matches=content.match(/^"(.*)"$/))&&(content=content.slice(1,-1)),allCSSRules[selector].style.content=""),[].slice.call(targetElms).forEach(function(elm){if(elm.insertedContent!==content)if(elm.insertedContent=content,url)loadContent(eval(url),elm,level);else try{var html=eval(content.slice(1,-1));setHtmlContent(elm,html,level)}catch(e){console.error("Could not evaluate expression: "+content)}}))}function pullElements(e,t){var n=document.querySelectorAll(e);[].slice.call(n).forEach(function(e){e.style.boxSizing="border-box";var t=parseInt(e.style.marginLeft||"0"),n=e.parentNode.offsetWidth+e.parentNode.offsetLeft-(e.offsetLeft+e.offsetWidth);e.style.marginLeft=t+n+"px",e.style.marginRight="0px",e.style.marginTop="-70px"})}function sizeElements(target,cssRules){console.log("sizeElements"),cssRules&&cssRules.forEach(function(cssRule){var style=cssRule.style,cssText=style.cssText.split("; ").filter(function(e){return e.trim().indexOf("content:")<0}).join(";\n"),content=style.content,targetElms=document.querySelectorAll(target);[].slice.call(targetElms).forEach(function(elm){var pos=cssRule.selectorText.toUpperCase().indexOf(" SIZE "),text,width={},height={},condition=cssRule.selectorText.substring(pos+6),result=!1,matches=condition.match(/(width|height)\[([^=]*)="(.*)"\]/);if(matches){var tekst=matches[3],div=document.createElement("div");div.style.cssText="position='absolute';width:auto;height:auto;white-space: nowrap;display:inline-block",div.innerHTML=tekst,elm.appendChild(div),width[tekst]=div.offsetWidth,height[tekst]=div.offsetHeight,elm.removeChild(div)}try{result=eval(condition)}catch(e){console.error("invalid SIZE condition!"+condition+", error: "+e)}if(result&&(console.log("SIZE condition: "+condition),elm.style.cssText=cssText.replace(/\$\{[^\}]*\}/g,function(v){var expr=v.substring(2,v.length-1);return eval(expr)}),content)){var html=""+eval(content.slice(1,-1));setHtmlContent(elm,html)}})})}function alignRule(e,t,n,s,l){pullBindings[n]=s,pullElements(n,s[0]),pullBoundElements()}function pullBoundElements(){Object.keys(pullBindings).forEach(function(e){window.setTimeout(function(){pullElements(e,pullBindings[e])},100)})}function sizeRule(e,t,n,s,l){sizeBindings[n]||(sizeBindings[n]=[]),sizeBindings[n].push(e[t]),sizeBoundElements()}function sizeBoundElements(){Object.keys(sizeBindings).forEach(function(e){window.setTimeout(function(){sizeElements(e,sizeBindings[e])},100)})}function timerRule(e,t,n,s,l){sizeBindings[n]||(sizeBindings[n]=[]),timerBindings[n].push(e[t]),timeoutBoundElements(s)}function timeoutBoundElements(){Object.keys(timerBindings).forEach(function(e){window.setTimeout(function(){styleElements(e,sizeBindings[e])},parsetInt(sources[0]))})}function styleElements(e,t){console.log("timer event for : "+e)}function componentRule(e,t,n,s,l){var o,r=Object.create(HTMLElement.prototype),a={},c=/\[template(Id|Url)="([\w-\/\.]*)"\]/i,i=s[0].match(c);i?(a.template={},i.shift(),o=i.shift().toLowerCase(),a.template[o]=i.shift()):a.content=e[t].style.content.replace(/^"/,"").replace(/"$/,""),components[n.toUpperCase()]=a,r.createdCallback=function(){var e=this.createShadowRoot(),t=components[this.tagName];if(t.template)if(t.template.id){var n=document.querySelector("#"+t.template.id),s=document.importNode(n.content,!0);e.appendChild(s)}else t.template.url&&fetch(t.template.url).then(function(e){return e.text()}).then(function(t){e.innerHTML=t});else e.innerHTML=t.content},document.registerElement&&document.registerElement(n,{prototype:r});var u=e[t];styleSheet.insertRule(n+"{"+u.style.cssText+"}",styleSheet.cssRules.length)}function extendRule(e,t,n,s,l){var o=s.map(function(t){return e[t]||(console.log("resolving rule fromSelector: "+t),compileRules(e)),e[t]?console.debug("Resolved rule fromSelector: "+t+" = "+e[t].style.cssText):console.error("Could not resolve rule fromSelector: "+t),e[t]?e[t].style.cssText:""}).join(" "),r=e[t];console.log("adding rule: "+n+"{"+o+r.style.cssText+"}");var a=styleSheet.insertRule(n+"{"+o+r.style.cssText+"}",styleSheet.cssRules.length);if(e[n]=styleSheet.cssRules[a],e[n].style.content){var c=0;insertContent(e,n,n,s,l,document,c)}}function applyRule(e,t,n,s,l){var o=document.querySelectorAll(n);classBindings[n]=s,[].slice.call(o).forEach(function(e){s.forEach(function(t){var s;if(s=t.match(/^\[(.*)\]$/)){var l=s[1].split("=");console.log("applying attr: "+s[1]+" to "+n),e.setAttribute(l[0],l[1]||l[0])}else console.log("applying class: "+t+" to "+n),e.classList.add(t)})})}function stateRule(e,t,n,s,l){console.log("binding message WHEN listener: "+s+" to "+t),console.log("binding message listener: "+s),stateListeners.push(makeStateChangeListener(n,s,t,e))}function eventRule(e,t,n,s,l){var o=s[0]||l;console.log("binding message events: "+o+" to "+n+" for "+l),evtBindings[n]={hash:o,event:l.substring(2)};var r=document.querySelectorAll(n);[].slice.call(r).forEach(function(e){console.log("adding eventlistener for "+o),"prevent"===o?e.xcssHandler=function(e){e.preventDefault(),e.stopPropagation()}:e.xcssHandler=makeEventListener(o),e.addEventListener(l.substring(2),e.xcssHandler)})}function LogicKeyword(){}function loadContent(e,t,n){for(;0===e.indexOf("@");)e=t.getAttribute(e.substring(1));fetch(e).then(function(s){s.text().then(function(s){console.log(e),console.log(s),e.indexOf("://")>0&&SCRIPTEXPR.test(s)||EVENTEXPR.test(s)?console.error("unsafe content ignored!"):setHtmlContent(t,s,n)})})}function setHtmlContent(e,t,n){function s(t,n){var s=e.tagName.toLowerCase();"input"===s||"textarea"===s?(Array.isArray(e.orgValue)||(e.orgValue=[e.value]),e.value=t):(Array.isArray(e.orgValue)||(e.orgValue=[e.innerHTML]),t!==e.dataHtml&&(e.innerHTML=t,e.dataHtml=t,bindAllContent(e,n||0),bindAllEvents(e),bindAllClasses(e)))}"string"==typeof t?s(t,n):t&&t.then&&t.then(function(e){s(e,n)})}function makeStateChangeListener(targetKey,sources,selector,cssRules){function stateChangeListener(newState){var matches,parms,url,jsKey,cssKey,value,placeholder,replacer,VAR_EXPR=/var\(--([^\)]*)\)/;console.log("event received: "+targetKey,"evt:",newState);var path=newState.path,state=newState.params,elmQuery=target;Object.keys(state).forEach(function(e){elmQuery=elmQuery.replace("${"+e+"}",state[e])});var content=cssRules[selector].style.content,match=targetStates.filter(function(e){return e.pattern.test(path)})[0];console.log(prevState);var prevMatch=targetStates.filter(function(e){return e.pattern.test(prevState.path||"")})[0];console.log(prevMatch);for(var elms=document.querySelectorAll(elmQuery),i=0;i<elms.length;i++){var elm=elms[i];if(console.log("event handled by ",elmQuery+"["+i+"]"),void 0===elm.cssText&&(elm.cssText=elm.style.cssText||""),match){if(parms=match.params,parms.forEach(function(parm){var parts=parm.split("=");if(1===parts.length&&content)return placeholder=new RegExp("\\$\\{"+parm+"\\}","g"),replacer=(state||{})[parm]||"",void(content=content.replace(placeholder,replacer));if(cssKey=parts.shift(),value=parts.join("=").replace(/^"/,"").replace(/"$/,""),value=value.replace(/^\\'/,"'").replace(/\\'$/,"'")){value=value.replace(/\$\{[^\}]*\}/g,function(e){return state[e.substring(2,e.length-1)]}),value=value.replace(/\\'/g,"'");try{state[cssKey]=eval(value)||""}catch(e){console.error("could not evaluate",value)}}}),cssText=cssRules[selector].style.cssText.split("; ").filter(function(e){return e.trim().indexOf("content:")<0}).join(";\n"),elm.style.cssText=cssText.replace(/\$\{[^\}]*\}/g,function(e){return state[e.substring(2,e.length-1)]}),[].slice.call(cssRules[selector].style,0).forEach(function(e){function t(e,t){var t=n.replace(VAR_EXPR,t);elm.style[e]=t}var n=cssRules[selector].style[e],s=n.match(VAR_EXPR);if(s&&s[1]){var l=s[1].split(","),o=l.shift(),r=state[o]||l[0];if(r){var a=e.replace(/(-\w)/,function(e){return e.substring(1).toUpperCase()});"function"==typeof r.then?r.then(function(e){t(a,e||l[0])}):t(a,r)}}}),content)if(console.log(prevMatch),matches=content.match(/^url\("([^)]*)"\)$/))url=evaluate(matches[1],state),loadContent(url,elm);else if(matches=content.match(/^url\(([^)]*)\)$/))url=evaluate(matches[1],state),loadContent(url,elm);else if(matches=content.match(/^"([^"]*)"$/)){var html=evaluate(matches[1],state);setHtmlContent(elm,html)}}else if(elms[i].style.cssText=elms[i].cssText,content&&Array.isArray(elm.orgValue)){var p=["input","textarea"].indexOf(elm.tagName)<0?"innerHTML":"value";elm[p]=elm.orgValue[0],elm.dataHtml=elm.orgValue[0]}}}console.log("makeStateChangeListener for: "+targetKey+", sources: "+sources);var targetStates=sources.map(function(e){var t=e.split(/[\[\]]/),n=t.shift().trim(),s=n.replace(/\s*\*\s*/g,".*").replace(/>/g,"/");return{path:n,pattern:new RegExp("^"+s+"$"),params:t.filter(function(e){return!!e.trim()})}}),cssText="",target=targetKey+"";return stateChangeListener}function evaluate(text,env){var result=text.replace(/\$\{[^\}]*\}/g,function(e){return env[e.substring(2,e.length-1)]});return eval(result)}function makeEventListener(msg){return function xcssHandler(elmEvent){var prevPath,hash=msg.split("[")[0],parms="",prefix="?",key,val,attr,elm=elmEvent.currentTarget||elmEvent.srcElement,matches=msg.match(/\[[^\]]+]/g)||[];matches.forEach(function(match){if(match=match.replace(/^\[/,"").replace(/\]$/,""),attr=match.split('="'),key=attr[0],val=attr[1]){val=val.replace(/\${[^\}]*}/g,function(e){var t=e.replace(/^\${/,"").replace(/}$/,"");return elm[t]||elm.getAttribute(t)}),[].slice.call(elm.attributes,0).forEach(function(e){val=val.replace("@{"+e.name+"}",e.value)});try{val=eval(val.replace(/^"/,"").replace(/"$/,""))}catch(e){val=val.replace(/^"/,"").replace(/"$/,""),console.log("eval to literal value as string")}}else val=elm[key]||elm.getAttribute(key);parms+=prefix+key+"="+encodeURIComponent(val),prefix="&"});var parts=location.hash.replace(/^#/,"").split("/").map(function(e){return e.split("?")[0]}),path=hash.replace(/^[#>+~\.\/]/,"").trim(),pathPos=parts.indexOf(path),prevHash=location.hash.replace(/^#/,"").split("/");0===hash.indexOf("+")?(pathPos>=0&&prevHash.pop(),prevHash.push(path),location.hash=prevHash.join("/")+parms):0===hash.indexOf("~")?("*"===path&&(pathPos=prevHash.length-1),pathPos>=0&&(location.hash=prevHash.filter(function(e,t){return t!==pathPos}).join("/"))):0===hash.indexOf(">")?(prevPath=prevHash.pop(),hash.indexOf(".")<0?prevHash.push(path):prevPath!==path&&(prevHash.push(prevPath),prevHash.push(path)),location.hash=prevHash.join("/")+parms):0===hash.indexOf(".")?(prevHash.push(path),location.hash=prevHash.join("/")+parms):0===hash.indexOf(":empty")||(location.hash=hash+parms),console.log("new Hash: "+location.hash)}}function collectRules(e,t){[].slice.call(e.styleSheets||[]).forEach(function(e){0===(e.href||"").indexOf(window.location.origin)&&[].slice.call(e.cssRules||[]).forEach(function(e){allCSSRules[e.selectorText]=e}),collectRules(e,!0)}),t||console.debug("collected nr of rules: "+Object.keys(allCSSRules).length)}function addNewStylesheet(){var e=document.createElement("style");return document.head.appendChild(e),e.sheet}var MAX_NESTING_LEVEL=100,allCSSRules={},visitedRules={},evtBindings={},classBindings={},contentBindings={},pullBindings={},sizeBindings={},timerBindings={},stateListeners=[],WHEN="when",AND="and",EXTENDS="extends",APPLIES="applies",EVENTS=[],LOGICAL="LOGICAL",prevState={},KEYWORD_FUNCTIONS={EXTENDS:extendRule,APPLIES:applyRule,COMPONENT:componentRule,WHEN:stateRule,PULL:alignRule,SIZE:sizeRule,AND:LogicKeyword,OR:LogicKeyword};for(var evtKey in HTMLElement.prototype)0===evtKey.indexOf("on")&&EVENTS.push(evtKey.toUpperCase());var keyWordsRegExp=Object.keys(KEYWORD_FUNCTIONS).concat(EVENTS).join("|"),KEYWORDS=new RegExp("\\s+("+keyWordsRegExp+"),?\\s+","i"),EVENTEXPR=new RegExp("\\W+("+EVENTS.join("|")+")\\W*=\\W*['\"]","i"),SCRIPTEXPR=/<script[>\W]/i,styleSheet=addNewStylesheet(),components={};document.addEventListener("DOMContentLoaded",processCSSRulesAsync),window.addEventListener("hashchange",stateChanged),window.addEventListener("resize",pullBoundElements),window.addEventListener("resize",sizeBoundElements)}();
//# sourceMappingURL=./dist/xcss.map