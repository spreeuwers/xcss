!function(e){"use strict";function t(){var e=location.hash.replace(/^#\/?/,"").split("/").map(function(e){var t=e.split("?"),n=(t[1]||"").split("&"),o=t[0],r={};return r[o]={},n.forEach(function(e){var t=e.split("="),n=t[0],c=decodeURIComponent(t[1]);r[o][n]=c}),r});e.path=e.map(function(e){return Object.keys(e)[0]}).join("/"),e.params={},e.forEach(function(t){var n=t[Object.keys(t)[0]];Object.keys(n).forEach(function(t){e.params[t]=n[t]})}),console.log("state:",e),F.forEach(function(t){t(e)}),window.setTimeout(function(){h()},100),Z=e}function n(e,t){return t&&t>k?void console.log("Max nesting level is: "+k):(t++,void Object.keys(U).forEach(function(n){a(U,n,null,null,null,e,t)}))}function o(e){Object.keys(N).forEach(function(t){for(var n=e||document,o=n.querySelectorAll(t),r=0;r<o.length;r++){var c=N[t];o[r].xcssHandler||(console.log("binding message events: "+c.hash+" to "+t),"prevent"===c.hash?o[r].xcssHandler=function(e){e.preventDefault(),e.stopPropagation()}:o[r].xcssHandler=A(c.hash),o[r].addEventListener(c.event,o[r].xcssHandler))}})}function r(e){Object.keys(I).forEach(function(t){var n=e||document,o=n.querySelectorAll(t)||[],r=I[t]||[];[].slice.call(o).forEach(function(e){r.forEach(function(n){console.log("applying "+n+" to "+t),e.classList.add(n)})})})}function c(t){function n(e,t){var n=document.querySelectorAll('[data-model="'+t+'"]');e instanceof Object&&[].slice.call(n).forEach(function(t){var n=t.getAttribute("name")||"";t.constructor.prototype.hasOwnProperty("value")?t.value=e[n]:t.innerHTML=e[n]})}Object.keys(D).forEach(function(o){var r=t||document,c=r.querySelectorAll(o)||[],l=D[o]||[],i=(l[0]||"").split("["),s=i.shift().trim();[].slice.call(c).forEach(function(t){if(t.getAttribute("data-model")!==s){var o=e(s,t);t.setAttribute("data-model",s),n(o,s),t.addEventListener("input",function(){o[t.name||""]=t.value,n(o,s)}),console.log("bound model ",s," to ",t.name)}})})}function l(){window.setTimeout(i,100)}function i(){console.time("processCSSRules"),C(document),s(M),console.timeEnd("processCSSRules"),t()}function s(e){Object.keys(e).forEach(function(t){var n,o,r,c="",l="",i=[],s={},u=t.split('"').map(function(e,t){return t%2===1?(s["$"+t]=e,"$"+t):e}).join('"'),f=u.split(G);if(!q[t])if(q[t]=e[t],console.log("parts: ["+f.join(" : "),"] selector:",t),n="",f.length>2){if(l=f.shift().trim().replace(/"\$(\d+)"/g,'"'+s.$1+'"'),c=f.shift().trim(),o=c.toUpperCase(),r=c.toLowerCase(),i=f.filter(function(e){var t=X[e.toUpperCase()];return n=t&&T!==t?c:n,!t}).map(function(e){return e.replace(/"\$\d+"/g,function(e){return'"'+s[e.replace(/"/g,"")]+'"'})}),n)return void console.error('cannot proces invalid xcss rule: "'+t+'" unexpected keyword "'+n+'"');X[o]?X[o](e,t,l,i,c):z.indexOf(o)>=0&&(w(e,t,l,i,r),x(e,t,l,[t],c))}else e[t].style&&e[t].style.content&&a(e,t,l,i,c)})}function a(t,n,o,r,c,l,i){var s,a,u=t[n].style.content||"",f=document.querySelectorAll(o||n);l&&(f=l.querySelectorAll(o||n)),/:(before|after)/.test(n)||(U[n]||(U[n]={style:{content:M[n].style.content}}),console.log("inserting content for: "+n),(a=u.match(/^"?url\(([^)]*)\)"?$/))&&(s=a[1],(a=s.match(/^"(.*)"$/))&&(s=s.slice(1,-1)),(a=u.match(/^"(.*)"$/))&&(u=u.slice(1,-1))),M[n].style.content="",[].slice.call(f).forEach(function(t){if(t.insertedContent!==u)if(t.insertedContent=u,s)/^@/.test(s)&&(s="'"+s+"'"),L(e(s,t),t,i);else try{var n=e(u.slice(1,-1),t);j(t,n,i)}catch(o){console.error("Could not evaluate expression: "+u)}}))}function u(e,t){var n=document.querySelectorAll(e);[].slice.call(n).forEach(function(e){e.style.boxSizing="border-box";var t=parseInt(e.style.marginLeft||"0"),n=e.parentNode.offsetWidth+e.parentNode.offsetLeft-(e.offsetLeft+e.offsetWidth);e.style.marginLeft=t+n+"px",e.style.marginRight="0px",e.style.marginTop="-70px"})}function f(t,n){console.log("sizeElements"),n&&n.forEach(function(n){var o=n.style,r=o.cssText.split("; ").filter(function(e){return e.trim().indexOf("content:")<0}).join(";\n"),c=o.content,l=document.querySelectorAll(t);[].slice.call(l).forEach(function(t){var o=n.selectorText.toUpperCase().indexOf(" SIZE "),l=n.selectorText.substring(o+6),i=!1,s=l.match(/(widthFor|heightFor)\[([^=]*)="(.*)"\]/);if(s){var a=s[3],u=document.createElement("div");u.style.cssText="position='absolute';width:auto;height:auto;white-space: nowrap;display:inline-block",u.innerHTML=a,t.appendChild(u),t.width=t.offsetWidth,t.height=t.offsetHeight,t.widthFor={},t.heightFor={},t.widthFor[a]=u.offsetWidth,t.heightFor[a]=u.offsetHeight,t.removeChild(u)}try{i=e(l,t)}catch(f){console.error("invalid SIZE condition! "+l+", error: "+f)}if(i&&(console.log("SIZE condition: "+l),t.style.cssText=r.replace(/\$\{[^\}]*\}/g,function(n){var o=n.substring(2,n.length-1);return e(o,t)}),c)){var p=""+e(c.slice(1,-1),t);j(t,p)}})})}function p(e,t,n,o,r){W[n]=o,u(n,o[0]),h()}function h(){Object.keys(W).forEach(function(e){window.setTimeout(function(){u(e,W[e])},100)})}function d(e,t,n,o,r){P[n]||(P[n]=[]),P[n].push(e[t]),g()}function g(){Object.keys(P).forEach(function(e){window.setTimeout(function(){f(e,P[e])},100)})}function m(e,t,n,o,r){P[n]||(P[n]=[]),V[n].push(e[t]),v(o)}function v(){Object.keys(V).forEach(function(e){window.setTimeout(function(){y(e,P[e])},parsetInt(sources[0]))})}function y(e,t){console.log("timer event for : "+e)}function E(e,t,n,o,r){var c,l=Object.create(HTMLElement.prototype),i={},s=/\[template(Id|Url)="([\w-\/\.]*)"\]/i,a=o[0].match(s);a?(i.template={},a.shift(),c=a.shift().toLowerCase(),i.template[c]=a.shift()):i.content=e[t].style.content.replace(/^"/,"").replace(/"$/,""),Y[n.toUpperCase()]=i,l.createdCallback=function(){var e=this.createShadowRoot(),t=Y[this.tagName];if(t.template)if(t.template.id){var n=document.querySelector("#"+t.template.id),o=document.importNode(n.content,!0);e.appendChild(o)}else t.template.url&&fetch(t.template.url).then(function(e){return e.text()}).then(function(t){e.innerHTML=t});else e.innerHTML=t.content},document.registerElement&&document.registerElement(n,{prototype:l});var u=e[t];Q.insertRule(n+"{"+u.style.cssText+"}",Q.cssRules.length)}function x(e,t,n,o,r){var c=o.map(function(t){return e[t]||(console.log("resolving rule fromSelector: "+t),s(e)),e[t]?console.debug("Resolved rule fromSelector: "+t+" = "+e[t].style.cssText):console.error("Could not resolve rule fromSelector: "+t),e[t]?e[t].style.cssText:""}).join(" "),l=e[t];console.log("adding rule: "+n+"{"+c+l.style.cssText+"}");var i=Q.insertRule(n+"{"+c+l.style.cssText+"}",Q.cssRules.length);if(e[n]=Q.cssRules[i],e[n].style.content){var u=0;a(e,n,n,o,r,document,u)}}function b(e,t,n,o,r){var c=document.querySelectorAll(n);I[n]=o,[].slice.call(c).forEach(function(e){o.forEach(function(t){var o;if(o=t.match(/^\[(.*)\]$/)){var r=o[1].split("=");console.log("applying attr: "+o[1]+" to "+n),e.setAttribute(r[0],r[1]||r[0])}else console.log("applying class: "+t+" to "+n),e.classList.add(t)})})}function O(e,t,n,o,r){console.log("binding message WHEN listener: "+o+" to "+t),console.log("binding message listener: "+o),F.push(S(n,o,t,e))}function w(e,t,n,o,r){var c=o[0]||r;console.log("binding message events: "+c+" to "+n+" for "+r),N[n]={hash:c,event:r.substring(2)};var l=document.querySelectorAll(n);[].slice.call(l).forEach(function(e){"prevent"===c?e.xcssHandler=function(e){e.preventDefault(),e.stopPropagation()}:e.xcssHandler=A(c),e.addEventListener(r.substring(2),e.xcssHandler)})}function T(){}function L(e,t,n){for(;0===e.indexOf("@");)e=t.getAttribute(e.substring(1));fetch(e).then(function(o){o.text().then(function(o){e.indexOf("://")>0&&K.test(o)||J.test(o)?console.error("unsafe content ignored!"):j(t,o,n)})})}function j(e,t,l){function i(t,l){var i=e.tagName.toLowerCase();e.constructor.prototype.hasOwnProperty("value")&&"select"!==i?(Array.isArray(e.orgValue)||(e.orgValue=[e.value]),e.value=t):(Array.isArray(e.orgValue)||(e.orgValue=[e.innerHTML]),t!==e.dataHtml&&(e.innerHTML=t,e.dataHtml=t,n(e,l||0),o(e),r(e),c(e)))}"string"==typeof t?i(t,l):t&&t.then&&t.then(function(e){i(e,l)})}function S(t,n,o,r){function c(n){var c,a,u,f,p,h,d,g=/var\(--([^\)]*)\)/;console.log("event received: "+t,"evt:",n);var m=n.path,v=n.params,y=s;Object.keys(v).forEach(function(e){y=y.replace("${"+e+"}",v[e])});var E=r[o].style.content,x=l.filter(function(e){return e.pattern.test(m)})[0];console.log(Z);var b=l.filter(function(e){return e.pattern.test(Z.path||"")})[0];console.log(b);for(var O=document.querySelectorAll(y),w=0;w<O.length;w++){var T=O[w];if(console.log("event handled by ",y+"["+w+"]"),void 0===T.cssText&&(T.cssText=T.style.cssText||""),x){if(a=x.params,a.forEach(function(t){var n=t.split("=");if(1===n.length&&E)return h=new RegExp("\\$\\{"+t+"\\}","g"),d=(v||{})[t]||"",void(E=E.replace(h,d));if(f=n.shift(),p=n.join("=").replace(/^"/,"").replace(/"$/,""),p=p.replace(/^\\'/,"'").replace(/\\'$/,"'")){p=p.replace(/\$\{[^\}]*\}/g,function(e){return v[e.substring(2,e.length-1)]}),p=p.replace(/\\'/g,"'");try{v[f]=e(p,T)||""}catch(o){console.error("could not evaluate",p)}}}),i=r[o].style.cssText.split("; ").filter(function(e){return e.trim().indexOf("content:")<0}).join(";\n"),T.style.cssText=i.replace(/\$\{[^\}]*\}/g,function(e){return v[e.substring(2,e.length-1)]}),[].slice.call(r[o].style,0).forEach(function(e){function t(e,t){var t=n.replace(g,t);T.style[e]=t}var n=r[o].style[e],c=n.match(g);if(c&&c[1]){var l=c[1].split(","),i=l.shift(),s=v[i]||l[0];if(s){var a=e.replace(/(-\w)/,function(e){return e.substring(1).toUpperCase()});"function"==typeof s.then?s.then(function(e){t(a,e||l[0])}):t(a,s)}}}),E)if(console.log(b),c=E.match(/^url\("([^)]*)"\)$/))u=$(c[1],v,T),L(u,T);else if(c=E.match(/^url\(([^)]*)\)$/))u=$(c[1],v,T),L(u,T);else if(c=E.match(/^"([^"]*)"$/)){var S=$(c[1],v,T);j(T,S)}}else if(O[w].style.cssText=O[w].cssText,E&&Array.isArray(T.orgValue)){var A=["input","textarea"].indexOf(T.tagName)<0?"innerHTML":"value";T[A]=T.orgValue[0],T.dataHtml=T.orgValue[0]}}}console.log("makeStateChangeListener for: "+t+", sources: "+n);var l=n.map(function(e){var t=e.split(/[\[\]]/),n=t.shift().trim(),o=n.replace(/\s*\*\s*/g,".*").replace(/>/g,"/");return{path:n,pattern:new RegExp("^"+o+"$"),params:t.filter(function(e){return!!e.trim()})}}),i="",s=t+"";return c}function $(t,n,o){var r=t.replace(/\$\{[^\}]*\}/g,function(e){return n[e.substring(2,e.length-1)]});try{return e(r,o)}catch(c){console.error(c)}}function A(t){return function(n){var o,r,c,l,i=t.split("[")[0],s="",a="?",u=n.currentTarget||n.srcElement,f=t.match(/\[[^\]]+]/g)||[];f.forEach(function(t){if(t=t.replace(/^\[/,"").replace(/\]$/,""),l=t.split('="'),r=l[0],c=l[1]){c=c.replace(/\${[^\}]*}/g,function(e){var t=e.replace(/^\${/,"").replace(/}$/,"");return u[t]||u.getAttribute(t)}),[].slice.call(u.attributes,0).forEach(function(e){c=c.replace("@{"+e.name+"}",e.value)});try{c=e(c.replace(/^"/,"").replace(/"$/,""),u)}catch(n){c=c.replace(/^"/,"").replace(/"$/,""),console.log("eval to literal value as string")}}else c=u[r]||u.getAttribute(r);s+=a+r+"="+encodeURIComponent(c),a="&"});var p=location.hash.replace(/^#/,"").split("/").map(function(e){return e.split("?")[0]}),h=i.replace(/^[#>+~\.\/-]/,"").trim(),d=p.indexOf(h),g=location.hash.replace(/^#/,"").split("/");0===i.indexOf("+")?(d>=0&&g.pop(),g.push(h),location.hash=g.join("/")+s):0===i.indexOf("-")?("*"===h&&(d=g.length-1),p[p.length-1]===h&&(location.hash=g.slice(0,g.length-2).join("/"))):0===i.indexOf("~")?("*"===h&&(d=g.length-1),d>=0&&(location.hash=g.filter(function(e,t){return t!==d}).join("/"))):0===i.indexOf(">")?(o=g.pop(),i.indexOf(".")<0?g.push(h):o!==h&&(g.push(o),g.push(h)),location.hash=g.join("/")+s):0===i.indexOf(".")?(g.push(h),location.hash=g.join("/")+s):0===i.indexOf(":empty")||(location.hash=i+s),console.log("new Hash: "+location.hash)}}function C(e,t){[].slice.call(e.styleSheets||[]).forEach(function(e){0===(e.href||"").indexOf(window.location.origin)&&[].slice.call(e.cssRules||[]).forEach(function(e){M[e.selectorText]=e}),C(e,!0)}),t||console.debug("collected nr of rules: "+Object.keys(M).length)}function H(e,t,n,o,r){console.log("model",t,n,o,r);document.querySelectorAll(n);D[n]=o,c(document)}function R(){var e=document.createElement("style");return document.head.appendChild(e),e.sheet}var k=100,M={},q={},N={},I={},U={},W={},P={},V={},D={},F=[],z=[],Z={},X={EXTENDS:x,APPLIES:b,COMPONENT:E,WHEN:O,PULL:p,SIZE:d,AND:T,OR:T,TIMER:m,MODEL:H};for(var _ in HTMLElement.prototype)0===_.indexOf("on")&&z.push(_.toUpperCase());var B=Object.keys(X).concat(z).join("|"),G=new RegExp("\\s+("+B+"),?\\s+","i"),J=new RegExp("\\W+("+z.join("|")+")\\W*=\\W*['\"]","i"),K=/<script[>\W]/i,Q=R(),Y={};document.addEventListener("DOMContentLoaded",l),window.addEventListener("hashchange",t),window.addEventListener("resize",h),window.addEventListener("resize",g)}(function _evaluate(expr,elm,self){return eval(expr)});
//# sourceMappingURL=./dist/xcss.map