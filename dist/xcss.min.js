!function(e){"use strict";function t(){var e=location.hash.replace(/^#\/?/,"").split("/").map(function(e){var t=e.split("?"),n=(t[1]||"").split("&"),o=t[0],r={};return r[o]={},n.forEach(function(e){var t=e.split("="),n=t[0],c=decodeURIComponent(t[1]);r[o][n]=c}),r});e.path=e.map(function(e){return Object.keys(e)[0]}).join("/"),e.params={},e.forEach(function(t){var n=t[Object.keys(t)[0]];Object.keys(n).forEach(function(t){e.params[t]=n[t]})}),console.log("state:",e),q.forEach(function(t){t(e)}),window.setTimeout(function(){p()},100),W=e}function n(e,t){return t&&t>j?void console.log("Max nesting level is: "+j):(t++,void Object.keys(k).forEach(function(n){s(k,n,null,null,null,e,t)}))}function o(e){Object.keys(A).forEach(function(t){for(var n=e||document,o=n.querySelectorAll(t),r=0;r<o.length;r++){var c=A[t];o[r].xcssHandler||(console.log("binding message events: "+c.hash+" to "+t),"prevent"===c.hash?o[r].xcssHandler=function(e){e.preventDefault(),e.stopPropagation()}:o[r].xcssHandler=L(c.hash),o[r].addEventListener(c.event,o[r].xcssHandler))}})}function r(e){Object.keys(R).forEach(function(t){var n=e||document,o=n.querySelectorAll(t)||[],r=R[t]||[];[].slice.call(o).forEach(function(e){r.forEach(function(n){console.log("applying "+n+" to "+t),e.classList.add(n)})})})}function c(){window.setTimeout(l,100)}function l(){console.time("processCSSRules"),$(document),i(C),console.timeEnd("processCSSRules"),t()}function i(e){Object.keys(e).forEach(function(t){var n,o,r,c="",l="",i=[],a={},u=t.split('"').map(function(e,t){return t%2===1?(a["$"+t]=e,"$"+t):e}).join('"'),f=u.split(P);if(!H[t])if(H[t]=e[t],console.log("parts: ["+f.join(" : "),"] selector:",t),n="",f.length>2){if(l=f.shift().trim().replace(/"\$(\d+)"/g,'"'+a.$1+'"'),c=f.shift().trim(),o=c.toUpperCase(),r=c.toLowerCase(),i=f.filter(function(e){var t=I[e.toUpperCase()];return n=t&&E!==t?c:n,!t}).map(function(e){return e.replace(/"\$\d+"/g,function(e){return'"'+a[e.replace(/"/g,"")]+'"'})}),n)return void console.error('cannot proces invalid xcss rule: "'+t+'" unexpected keyword "'+n+'"');I[o]?I[o](e,t,l,i,c):U.indexOf(o)>=0&&x(e,t,l,i,r)}else e[t].style.content&&s(e,t,l,i,c)})}function s(t,n,o,r,c,l,i){var s,a,u=t[n].style.content||"",f=document.querySelectorAll(n);l&&(f=l.querySelectorAll(n)),/:(before|after)/.test(n)||(k[n]||(k[n]={style:{content:C[n].style.content}}),console.log("inserting content for: "+n),(a=u.match(/^url\(([^)]*)\)$/))&&(s=a[1],(a=s.match(/^"(.*)"$/))&&(s=s.slice(1,-1)),(a=u.match(/^"(.*)"$/))&&(u=u.slice(1,-1)),C[n].style.content=""),[].slice.call(f).forEach(function(t){if(t.insertedContent!==u)if(t.insertedContent=u,s)b(e(s),t,i);else try{var n=e(u.slice(1,-1));w(t,n,i)}catch(o){console.error("Could not evaluate expression: "+u)}}))}function a(e,t){var n=document.querySelectorAll(e);[].slice.call(n).forEach(function(e){e.style.boxSizing="border-box";var t=parseInt(e.style.marginLeft||"0"),n=e.parentNode.offsetWidth+e.parentNode.offsetLeft-(e.offsetLeft+e.offsetWidth);e.style.marginLeft=t+n+"px",e.style.marginRight="0px",e.style.marginTop="-70px"})}function u(t,n){console.log("sizeElements"),n&&n.forEach(function(n){var o=n.style,r=o.cssText.split("; ").filter(function(e){return e.trim().indexOf("content:")<0}).join(";\n"),c=o.content,l=document.querySelectorAll(t);[].slice.call(l).forEach(function(t){var o=n.selectorText.toUpperCase().indexOf(" SIZE "),l={},i=n.selectorText.substring(o+6),s=!1,a=i.match(/(widthFor|heightFor)\[([^=]*)="(.*)"\]/);if(a){var u=a[3],f=document.createElement("div");f.style.cssText="position='absolute';width:auto;height:auto;white-space: nowrap;display:inline-block",f.innerHTML=u,t.appendChild(f),t.width=t.offsetWidth,t.height=t.offsetHeight,t.widthFor={},t.heightFor={},t.widthFor[u]=f.offsetWidth,t.heightFor[u]=f.offsetHeight,t.removeChild(f)}try{s=e(i,t,l)}catch(p){console.error("invalid SIZE condition! "+i+", error: "+p)}if(s&&(console.log("SIZE condition: "+i),t.style.cssText=r.replace(/\$\{[^\}]*\}/g,function(t){var n=t.substring(2,t.length-1);return e(n)}),c)){var h=""+e(c.slice(1,-1));w(t,h)}})})}function f(e,t,n,o,r){N[n]=o,a(n,o[0]),p()}function p(){Object.keys(N).forEach(function(e){window.setTimeout(function(){a(e,N[e])},100)})}function h(e,t,n,o,r){M[n]||(M[n]=[]),M[n].push(e[t]),d()}function d(){Object.keys(M).forEach(function(e){window.setTimeout(function(){u(e,M[e])},100)})}function g(e,t,n,o,r){var c,l=Object.create(HTMLElement.prototype),i={},s=/\[template(Id|Url)="([\w-\/\.]*)"\]/i,a=o[0].match(s);a?(i.template={},a.shift(),c=a.shift().toLowerCase(),i.template[c]=a.shift()):i.content=e[t].style.content.replace(/^"/,"").replace(/"$/,""),X[n.toUpperCase()]=i,l.createdCallback=function(){var e=this.createShadowRoot(),t=X[this.tagName];if(t.template)if(t.template.id){var n=document.querySelector("#"+t.template.id),o=document.importNode(n.content,!0);e.appendChild(o)}else t.template.url&&fetch(t.template.url).then(function(e){return e.text()}).then(function(t){e.innerHTML=t});else e.innerHTML=t.content},document.registerElement&&document.registerElement(n,{prototype:l});var u=e[t];Z.insertRule(n+"{"+u.style.cssText+"}",Z.cssRules.length)}function v(e,t,n,o,r){var c=o.map(function(t){return e[t]||(console.log("resolving rule fromSelector: "+t),i(e)),e[t]?console.debug("Resolved rule fromSelector: "+t+" = "+e[t].style.cssText):console.error("Could not resolve rule fromSelector: "+t),e[t]?e[t].style.cssText:""}).join(" "),l=e[t];console.log("adding rule: "+n+"{"+c+l.style.cssText+"}");var a=Z.insertRule(n+"{"+c+l.style.cssText+"}",Z.cssRules.length);if(e[n]=Z.cssRules[a],e[n].style.content){var u=0;s(e,n,n,o,r,document,u)}}function m(e,t,n,o,r){var c=document.querySelectorAll(n);R[n]=o,[].slice.call(c).forEach(function(e){o.forEach(function(t){var o;if(o=t.match(/^\[(.*)\]$/)){var r=o[1].split("=");console.log("applying attr: "+o[1]+" to "+n),e.setAttribute(r[0],r[1]||r[0])}else console.log("applying class: "+t+" to "+n),e.classList.add(t)})})}function y(e,t,n,o,r){console.log("binding message WHEN listener: "+o+" to "+t),console.log("binding message listener: "+o),q.push(T(n,o,t,e))}function x(e,t,n,o,r){var c=o[0]||r;console.log("binding message events: "+c+" to "+n+" for "+r),A[n]={hash:c,event:r.substring(2)};var l=document.querySelectorAll(n);[].slice.call(l).forEach(function(e){console.log("adding eventlistener for "+c),"prevent"===c?e.xcssHandler=function(e){e.preventDefault(),e.stopPropagation()}:e.xcssHandler=L(c),e.addEventListener(r.substring(2),e.xcssHandler)})}function E(){}function b(e,t,n){for(;0===e.indexOf("@");)e=t.getAttribute(e.substring(1));fetch(e).then(function(o){o.text().then(function(o){console.log(e),console.log(o),e.indexOf("://")>0&&z.test(o)||D.test(o)?console.error("unsafe content ignored!"):w(t,o,n)})})}function w(e,t,c){function l(t,c){var l=e.tagName.toLowerCase();"input"===l||"textarea"===l?(Array.isArray(e.orgValue)||(e.orgValue=[e.value]),e.value=t):(Array.isArray(e.orgValue)||(e.orgValue=[e.innerHTML]),t!==e.dataHtml&&(e.innerHTML=t,e.dataHtml=t,n(e,c||0),o(e),r(e)))}"string"==typeof t?l(t,c):t&&t.then&&t.then(function(e){l(e,c)})}function T(t,n,o,r){function c(n){var c,a,u,f,p,h,d,g=/var\(--([^\)]*)\)/;console.log("event received: "+t,"evt:",n);var v=n.path,m=n.params,y=s;Object.keys(m).forEach(function(e){y=y.replace("${"+e+"}",m[e])});var x=r[o].style.content,E=l.filter(function(e){return e.pattern.test(v)})[0];console.log(W);var T=l.filter(function(e){return e.pattern.test(W.path||"")})[0];console.log(T);for(var L=document.querySelectorAll(y),$=0;$<L.length;$++){var S=L[$];if(console.log("event handled by ",y+"["+$+"]"),void 0===S.cssText&&(S.cssText=S.style.cssText||""),E){if(a=E.params,a.forEach(function(t){var n=t.split("=");if(1===n.length&&x)return h=new RegExp("\\$\\{"+t+"\\}","g"),d=(m||{})[t]||"",void(x=x.replace(h,d));if(f=n.shift(),p=n.join("=").replace(/^"/,"").replace(/"$/,""),p=p.replace(/^\\'/,"'").replace(/\\'$/,"'")){p=p.replace(/\$\{[^\}]*\}/g,function(e){return m[e.substring(2,e.length-1)]}),p=p.replace(/\\'/g,"'");try{m[f]=e(p)||""}catch(o){console.error("could not evaluate",p)}}}),i=r[o].style.cssText.split("; ").filter(function(e){return e.trim().indexOf("content:")<0}).join(";\n"),S.style.cssText=i.replace(/\$\{[^\}]*\}/g,function(e){return m[e.substring(2,e.length-1)]}),[].slice.call(r[o].style,0).forEach(function(e){function t(e,t){var t=n.replace(g,t);S.style[e]=t}var n=r[o].style[e],c=n.match(g);if(c&&c[1]){var l=c[1].split(","),i=l.shift(),s=m[i]||l[0];if(s){var a=e.replace(/(-\w)/,function(e){return e.substring(1).toUpperCase()});"function"==typeof s.then?s.then(function(e){t(a,e||l[0])}):t(a,s)}}}),x)if(console.log(T),c=x.match(/^url\("([^)]*)"\)$/))u=O(c[1],m),b(u,S);else if(c=x.match(/^url\(([^)]*)\)$/))u=O(c[1],m),b(u,S);else if(c=x.match(/^"([^"]*)"$/)){var j=O(c[1],m);w(S,j)}}else if(L[$].style.cssText=L[$].cssText,x&&Array.isArray(S.orgValue)){var C=["input","textarea"].indexOf(S.tagName)<0?"innerHTML":"value";S[C]=S.orgValue[0],S.dataHtml=S.orgValue[0]}}}console.log("makeStateChangeListener for: "+t+", sources: "+n);var l=n.map(function(e){var t=e.split(/[\[\]]/),n=t.shift().trim(),o=n.replace(/\s*\*\s*/g,".*").replace(/>/g,"/");return{path:n,pattern:new RegExp("^"+o+"$"),params:t.filter(function(e){return!!e.trim()})}}),i="",s=t+"";return c}function O(t,n){var o=t.replace(/\$\{[^\}]*\}/g,function(e){return n[e.substring(2,e.length-1)]});try{return e(o)}catch(r){console.error(r)}}function L(t){return function(n){var o,r,c,l,i=t.split("[")[0],s="",a="?",u=n.currentTarget||n.srcElement,f=t.match(/\[[^\]]+]/g)||[];f.forEach(function(t){if(t=t.replace(/^\[/,"").replace(/\]$/,""),l=t.split('="'),r=l[0],c=l[1]){c=c.replace(/\${[^\}]*}/g,function(e){var t=e.replace(/^\${/,"").replace(/}$/,"");return u[t]||u.getAttribute(t)}),[].slice.call(u.attributes,0).forEach(function(e){c=c.replace("@{"+e.name+"}",e.value)});try{c=e(c.replace(/^"/,"").replace(/"$/,""))}catch(n){c=c.replace(/^"/,"").replace(/"$/,""),console.log("eval to literal value as string")}}else c=u[r]||u.getAttribute(r);s+=a+r+"="+encodeURIComponent(c),a="&"});var p=location.hash.replace(/^#/,"").split("/").map(function(e){return e.split("?")[0]}),h=i.replace(/^[#>+~\.\/]/,"").trim(),d=p.indexOf(h),g=location.hash.replace(/^#/,"").split("/");0===i.indexOf("+")?(d>=0&&g.pop(),g.push(h),location.hash=g.join("/")+s):0===i.indexOf("~")?("*"===h&&(d=g.length-1),d>=0&&(location.hash=g.filter(function(e,t){return t!==d}).join("/"))):0===i.indexOf(">")?(o=g.pop(),i.indexOf(".")<0?g.push(h):o!==h&&(g.push(o),g.push(h)),location.hash=g.join("/")+s):0===i.indexOf(".")?(g.push(h),location.hash=g.join("/")+s):0===i.indexOf(":empty")||(location.hash=i+s),console.log("new Hash: "+location.hash)}}function $(e,t){[].slice.call(e.styleSheets||[]).forEach(function(e){0===(e.href||"").indexOf(window.location.origin)&&[].slice.call(e.cssRules||[]).forEach(function(e){C[e.selectorText]=e}),$(e,!0)}),t||console.debug("collected nr of rules: "+Object.keys(C).length)}function S(){var e=document.createElement("style");return document.head.appendChild(e),e.sheet}var j=100,C={},H={},A={},R={},k={},N={},M={},q=[],U=[],W={},I={EXTENDS:v,APPLIES:m,COMPONENT:g,WHEN:y,PULL:f,SIZE:h,AND:E,OR:E};for(var V in HTMLElement.prototype)0===V.indexOf("on")&&U.push(V.toUpperCase());var F=Object.keys(I).concat(U).join("|"),P=new RegExp("\\s+("+F+"),?\\s+","i"),D=new RegExp("\\W+("+U.join("|")+")\\W*=\\W*['\"]","i"),z=/<script[>\W]/i,Z=S(),X={};document.addEventListener("DOMContentLoaded",c),window.addEventListener("hashchange",t),window.addEventListener("resize",p),window.addEventListener("resize",d)}(function _evaluate(expr,elm,env){return eval(expr)});
//# sourceMappingURL=./dist/xcss.map